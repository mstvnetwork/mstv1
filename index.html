<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MSTV NETWORK</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0; background: #111; color: #eee;
    display: flex; flex-direction: column; min-height: 100vh;
  }
  header {
    padding: 10px 20px; background: #222;
    font-size: 1.5em; font-weight: bold;
  }
  main {
    flex: 1;
    display: flex; flex-direction: column; align-items: center; padding: 20px;
  }
  #channelSelect {
    margin-bottom: 10px;
    font-size: 1em;
    color: goldenrod;
    background: #222;
    border: 1px solid goldenrod;
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
  }
  #channelSelect option[disabled] {
    color: goldenrod;
  }
  #videoContainer {
    position: relative;
    width: 90vw; max-width: 900px; aspect-ratio: 16 / 9;
    background: black;
    overflow: hidden;
  }
  video {
    width: 100%; height: 100%;
    background: black;
  }
  #muteToggle {
    position: absolute;
    top: 10px; right: 10px;
    font-size: 1.8em;
    cursor: pointer;
    user-select: none;
    color: #eee;
    text-shadow: 0 0 6px #000;
  }
  #scrollBanner {
    width: 90vw; max-width: 900px;
    margin-top: 10px;
    background: #0033cc;
    color: white;
    font-weight: bold;
    padding: 8px 12px;
    overflow: hidden;
    white-space: nowrap;
    box-sizing: border-box;
  }
  #scrollBanner span {
    display: inline-block;
    padding-left: 100%;
    animation: scrollLeft 15s linear infinite;
  }
  @keyframes scrollLeft {
    from { transform: translateX(0); }
    to { transform: translateX(-100%); }
  }
  footer {
    background: #222;
    padding: 15px 20px;
    text-align: center;
    font-size: 0.9em;
    color: #aaa;
  }
  #followFacebook {
    margin-top: 12px;
    color: #3b5998;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    user-select: none;
  }
  #followFacebook svg {
    width: 24px; height: 24px;
    margin-right: 6px;
    fill: #3b5998;
  }
</style>
</head>
<body>

<header>MSTV NETWORK</header>

<main>
  <select id="channelSelect" aria-label="Select TV Channel">
    <option disabled selected>Click select channels</option>
  </select>

  <div id="videoContainer">
    <video id="videoPlayer" playsinline controls></video>
    <div id="muteToggle" title="Toggle Mute">ðŸ”‡</div>
  </div>

  <div id="scrollBanner"><span>&nbsp;</span></div>

  <div id="followFacebook" onclick="window.open('https://facebook.com/mstvnetwork','_blank')">
    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
      <path d="M22.675 0H1.325C.593 0 0 .593 0 1.325v21.351C0 23.407.593 24 1.325 24h11.494v-9.294H9.691v-3.622h3.128V8.413c0-3.1 1.893-4.788 4.659-4.788 1.325 0 2.466.099 2.798.143v3.245l-1.92.001c-1.506 0-1.797.716-1.797 1.765v2.317h3.588l-.467 3.622h-3.12V24h6.116c.73 0 1.324-.593 1.324-1.324V1.325C24 .593 23.407 0 22.675 0z"/>
    </svg>
    Click here to follow
  </div>
</main>

<footer>
  About us | &copy; 2025 MSTV NETWORK
</footer>

<script>
const channels = [
  {
    name: "MSTV Channel 1",
    json_url: "https://raw.githubusercontent.com/mstvnetwork/mstv1/main/sync-ch1.json"
  },
  {
    name: "MSTV Channel 2",
    json_url: "https://raw.githubusercontent.com/mstvnetwork/mstv1/main/sync-ch2.json"
  }
];

const videoPlayer = document.getElementById('videoPlayer');
const channelSelect = document.getElementById('channelSelect');
const scrollBanner = document.getElementById('scrollBanner').querySelector('span');
const muteToggle = document.getElementById('muteToggle');

let videoList = [];
let currentVideoIndex = -1;
let isMuted = true;
let currentSrc = null;
let seekingInProgress = false;
let syncInterval = null;

// Init channel selector dropdown
function populateChannelSelect() {
  channels.forEach((ch, i) => {
    const option = document.createElement('option');
    option.value = i;
    option.textContent = ch.name;
    option.style.color = 'black';
    channelSelect.appendChild(option);
  });
}
populateChannelSelect();

channelSelect.addEventListener('change', () => {
  const selectedIndex = parseInt(channelSelect.value);
  if (isNaN(selectedIndex) || !channels[selectedIndex]) {
    clearVideo();
    return;
  }
  loadChannel(selectedIndex);
});

function clearVideo() {
  videoList = [];
  currentVideoIndex = -1;
  currentSrc = null;
  seekingInProgress = false;
  videoPlayer.pause();
  videoPlayer.removeAttribute('src');
  videoPlayer.load();
  scrollBanner.textContent = '';
  setPlaceholder();
  clearInterval(syncInterval);
}

// Placeholder video - YouTube embed with play button (iframe)
function setPlaceholder() {
  clearInterval(syncInterval);
  videoPlayer.pause();
  videoPlayer.removeAttribute('src');
  videoPlayer.load();
  scrollBanner.textContent = 'Please select a channel to start viewing.';
}

// Load JSON and start sync
async function loadChannel(index) {
  clearVideo();
  try {
    const resp = await fetch(channels[index].json_url, {cache: "no-store"});
    if (!resp.ok) throw new Error('Failed to load playlist JSON');
    const json = await resp.json();
    if (!json.video_list || json.video_list.length === 0) throw new Error('Empty video list');

    videoList = json.video_list;
    currentVideoIndex = -1;
    currentSrc = null;
    seekingInProgress = false;

    startSyncInterval();
  } catch (e) {
    alert('Error loading channel playlist: ' + e.message);
    setPlaceholder();
  }
}

function calculateSync() {
  if (!videoList.length) return null;
  const startTime = new Date(channels[channelSelect.value]?.json_url ? (new Date()) : 0); // fallback if no start_time_utc
  try {
    const startUTC = new Date(channels[channelSelect.value]?.start_time_utc || videoList[0].start_time_utc || 0);
    if (!startUTC) return null;
    const now = new Date();
    let elapsedMs = now.getTime() - startUTC.getTime();
    if (elapsedMs < 0) elapsedMs = 0;

    let totalDuration = 0;
    for (let i = 0; i < videoList.length; i++) {
      totalDuration += videoList[i].duration_seconds;
    }
    elapsedMs = elapsedMs % (totalDuration * 1000);

    let acc = 0;
    for (let i = 0; i < videoList.length; i++) {
      acc += videoList[i].duration_seconds * 1000;
      if (elapsedMs < acc) {
        return {
          index: i,
          elapsed: (elapsedMs - (acc - videoList[i].duration_seconds * 1000)) / 1000
        };
      }
    }
  } catch {
    return null;
  }
  return null;
}

function updateMuteIcon() {
  muteToggle.textContent = isMuted ? 'ðŸ”‡' : 'ðŸ”Š';
  videoPlayer.muted = isMuted;
  localStorage.setItem('mstv-muted', isMuted ? '1' : '0');
}

// Main sync function
function playSyncedVideo() {
  if (!videoList.length) {
    setPlaceholder();
    return;
  }
  const sync = calculateSync();
  if (!sync) return;

  const targetVideo = videoList[sync.index];
  const targetSrc = targetVideo.url;
  const targetTime = sync.elapsed;

const SEEK_THRESHOLD = 1.0; // seconds, increase tolerance

if (currentSrc !== targetSrc) {
  currentSrc = targetSrc;
  seekingInProgress = true;

  videoPlayer.src = targetSrc;
  scrollBanner.textContent = targetVideo.title;
  videoPlayer.muted = isMuted;
  updateMuteIcon();

  videoPlayer.addEventListener('loadedmetadata', function onLoad() {
    videoPlayer.removeEventListener('loadedmetadata', onLoad);
    videoPlayer.currentTime = targetTime;
    videoPlayer.play().catch(() => {});
    seekingInProgress = false;
  });
} else if (!seekingInProgress) {
  const diff = Math.abs(videoPlayer.currentTime - targetTime);
  if (diff > SEEK_THRESHOLD) {
    seekingInProgress = true;
    videoPlayer.currentTime = targetTime;
    setTimeout(() => {
      seekingInProgress = false;
    }, 1000);
  }
}

function startSyncInterval() {
  if (syncInterval) clearInterval(syncInterval);
  syncInterval = setInterval(playSyncedVideo, 2000);
}

// Mute toggle click
muteToggle.addEventListener('click', () => {
  isMuted = !isMuted;
  updateMuteIcon();
  videoPlayer.muted = isMuted;
  if (!videoPlayer.paused) videoPlayer.play().catch(() => {});
});

// Load mute setting from localStorage
(function loadMuteSetting() {
  const stored = localStorage.getItem('mstv-muted');
  isMuted = stored === '0' ? false : true;
  updateMuteIcon();
})();

// Start placeholder on page load
setPlaceholder();

</script>
</body>
</html>
