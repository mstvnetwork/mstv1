<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Global Sync MP4 Channel</title>
  <style>
    body { margin: 0; background: black; }
    #video { width: 100%; height: 100vh; background: black; object-fit: contain; }
    #banner {
      position: fixed; bottom: 0; width: 100%;
      background: blue; color: white; padding: 8px;
      white-space: nowrap; overflow: hidden;
    }
    #banner span {
      display: inline-block;
      animation: scroll 15s linear infinite;
    }
    @keyframes scroll {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }
    #mute-btn {
      position: fixed; top: 10px; right: 10px;
      background: rgba(0,0,0,0.6); color: white;
      font-size: 20px; padding: 6px 10px;
      border: none; border-radius: 5px;
    }
    #spinner {
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      border: 6px solid white;
      border-top: 6px solid gold;
      border-radius: 50%;
      width: 50px; height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

<video id="video" autoplay muted playsinline></video>
<div id="spinner"></div>
<button id="mute-btn">🔇</button>
<div id="banner"><span>Loading...</span></div>
<script>
const video = document.getElementById('video');
const banner = document.querySelector('#banner span');
const muteBtn = document.getElementById('mute-btn');
const spinner = document.getElementById('spinner');

const params = new URLSearchParams(window.location.search);
const ch = params.get("ch") || "1";
const playlistURL = `sync-ch${ch}.json`;

let playlist = [];
let startTimeUTC = 0;
let currentIndex = 0;
let currentSeek = 0;

fetch(playlistURL)
  .then(res => res.json())
  .then(data => {
    playlist = data.video_list;
    startTimeUTC = new Date(data.start_time_utc).getTime() / 1000;
    syncAndPlay();
  });

function syncAndPlay() {
  const now = Date.now() / 1000;
  const elapsed = now - startTimeUTC;

  const totalDuration = playlist.reduce((sum, v) => sum + v.duration_seconds, 0);
  const loopTime = elapsed % totalDuration;

  let sum = 0;
  let selectedIndex = 0;
  let selectedSeek = 0;

  for (let i = 0; i < playlist.length; i++) {
    const dur = playlist[i].duration_seconds;
    if (loopTime < sum + dur) {
      selectedIndex = i;
      selectedSeek = Math.floor(loopTime - sum);
      break;
    }
    sum += dur;
  }

  // ONLY change video if we're not already on the correct one
  if (selectedIndex !== currentIndex || Math.abs(selectedSeek - currentSeek) > 2) {
    currentIndex = selectedIndex;
    currentSeek = selectedSeek;
    playVideo(playlist[currentIndex], currentSeek);
  }
}

function playVideo(videoItem, seekTime) {
  banner.textContent = "Now Playing: " + videoItem.title;
  video.src = videoItem.url;

  video.onloadedmetadata = () => {
    const safeSeek = Math.min(video.duration - 1, seekTime);
    video.currentTime = safeSeek;
    spinner.style.display = 'none';
    video.play().catch(console.warn);
  };

  video.onerror = () => {
    spinner.style.display = 'none';
    banner.textContent = "⚠️ Failed to load video.";
  };
}

video.onended = () => {
  syncAndPlay(); // Check which video should now play
};

muteBtn.onclick = () => {
  video.muted = !video.muted;
  muteBtn.textContent = video.muted ? "🔇" : "🔊";
};

// Resync every 20s to fix drift or tab switching
setInterval(syncAndPlay, 20000);
</script>
</body>
</html>
