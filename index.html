<!DOCTYPE html>
<html>
<head>
Â  <title>Global Sync YouTube Player (Multichannel Support)</title>
Â  <style>
Â  Â  body {
Â  Â  Â  font-family: sans-serif;
Â  Â  Â  background: #000;
Â  Â  Â  color: white;
Â  Â  Â  margin: 0;
Â  Â  Â  text-align: center;
Â  Â  }
Â  Â  #player-container {
Â  Â  Â  position: relative;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 0;
Â  Â  Â  padding-bottom: 56.25%; /* 16:9 aspect ratio */
Â  Â  }
Â  Â  #player {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 0; left: 0;
Â  Â  Â  width: 100%; height: 100%;
Â  Â  Â  pointer-events: none;
Â  Â  }
Â  Â  #mute-toggle {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 8px; right: 8px;
Â  Â  Â  font-size: 24px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  z-index: 10;
Â  Â  Â  background: rgba(0,0,0,0.6);
Â  Â  Â  border-radius: 50%;
Â  Â  Â  padding: 6px;
Â  Â  Â  user-select: none;
Â  Â  }
Â  Â  #scrolling-banner {
Â  Â  Â  position: absolute;
Â  Â  Â  bottom: 0;
Â  Â  Â  width: 100%;
Â  Â  Â  background-color: #007BFF;
Â  Â  Â  color: white;
Â  Â  Â  font-size: clamp(14px, 3vw, 20px);
Â  Â  Â  font-weight: bold;
Â  Â  Â  font-family: monospace;
Â  Â  Â  overflow: hidden;
Â  Â  Â  user-select: none;
Â  Â  Â  z-index: 10;
Â  Â  Â  pointer-events: none;
Â  Â  Â  padding: 8px 0;
Â  Â  }
Â  Â  #marquee-text {
Â  Â  Â  display: inline-block;
Â  Â  Â  white-space: nowrap;
Â  Â  Â  padding-left: 100%;
Â  Â  Â  animation: marquee 15s linear infinite;
Â  Â  }
Â  Â  @keyframes marquee {
Â  Â  Â  0% { transform: translateX(0%); }
Â  Â  Â  100% { transform: translateX(-100%); }
Â  Â  }
Â  Â  #loading-overlay {
Â  Â  Â  position: fixed;
Â  Â  Â  inset: 0;
Â  Â  Â  background-color: #000;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  z-index: 9999;
Â  Â  }
Â  Â  #loading-spinner {
Â  Â  Â  width: 60px;
Â  Â  Â  height: 60px;
Â  Â  Â  border: 3px solid rgba(255, 215, 0, 0.2);
Â  Â  Â  border-top: 3px solid #FFD700;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  animation: spin 0.8s linear infinite;
Â  Â  Â  margin-bottom: 16px;
Â  Â  Â  box-shadow: 0 0 10px #FFD70088;
Â  Â  }
Â  Â  @keyframes spin {
Â  Â  Â  to { transform: rotate(360deg); }
Â  Â  }
Â  Â  #loading-text {
Â  Â  Â  color: #FFD700;
Â  Â  Â  font-size: 20px;
Â  Â  Â  font-weight: 600;
Â  Â  Â  font-family: "Courier New", monospace;
Â  Â  Â  text-shadow: 0 0 6px #FFD70099;
Â  Â  Â  letter-spacing: 1px;
Â  Â  }
Â  Â  /* New styles for warning banner and fallback button */
Â  Â  #warning-banner {
Â  Â  Â  position: fixed;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  width: 100%;
Â  Â  Â  background-color: #cc0000;
Â  Â  Â  color: white;
Â  Â  Â  font-weight: bold;
Â  Â  Â  padding: 10px 0;
Â  Â  Â  font-family: monospace;
Â  Â  Â  z-index: 10000;
Â  Â  Â  user-select: none;
Â  Â  }
Â  Â  #fallback-button {
Â  Â  Â  display: inline-block;
Â  Â  Â  margin-top: 20px;
Â  Â  Â  padding: 12px 24px;
Â  Â  Â  background-color: #ff4500;
Â  Â  Â  color: white;
Â  Â  Â  font-weight: bold;
Â  Â  Â  text-decoration: none;
Â  Â  Â  font-family: monospace;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  cursor: pointer;
Â  Â  }
Â  </style>
</head>
<body>

Â  <div id="warning-banner" style="display:none;">
Â  Â  âš ï¸ Your browser is known to have issues with embedded YouTube playback. Please use the button below to watch on YouTube.
Â  </div>

Â  <div id="player-container">
Â  Â  <div id="player"></div>
Â  Â  <div id="mute-toggle">ğŸ”‡</div>
Â  Â  <div id="scrolling-banner">
Â  Â  Â  <div id="marquee-text">Loading...</div>
Â  Â  </div>
Â  </div>

Â  <div id="loading-overlay">
Â  Â  <div id="loading-spinner"></div>
Â  Â  <div id="loading-text">Stream Loading...</div>
Â  </div>

Â  <script>
Â  Â  // Detect problematic browsers
Â  Â  function detectProblematicBrowser() {
Â  Â  Â  const ua = navigator.userAgent || navigator.vendor || window.opera;
Â  Â  Â  // Regex patterns for browsers
Â  Â  Â  const patterns = [
Â  Â  Â  Â  /SamsungBrowser/i,
Â  Â  Â  Â  /FBAV/i,Â  Â  Â  Â  Â  Â // Facebook app
Â  Â  Â  Â  /Instagram/i,
Â  Â  Â  Â  /Twitter/i,
Â  Â  Â  Â  /MiuiBrowser/i,
Â  Â  Â  Â  /Silk/i,
Â  Â  Â  Â  /Opera Mini/i
Â  Â  Â  ];
Â  Â  Â  return patterns.some(pattern => pattern.test(ua));
Â  Â  }

Â  Â  // Show red warning banner and replace player with fallback button
Â  Â  function showWarningAndFallback() {
Â  Â  Â  document.getElementById('warning-banner').style.display = 'block';
Â  Â  Â  const container = document.getElementById('player-container');
Â  Â  Â  container.innerHTML = ''; // Clear existing player & controls

Â  Â  Â  // Construct YouTube watch URL for current video or default first video
Â  Â  Â  const videoId = (playlist.length > 0) ? playlist[currentVideoIndex].id : null;
Â  Â  Â  if (!videoId) {
Â  Â  Â  Â  container.innerHTML = '<p style="color:#f00;">No video available to watch.</p>';
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  const ytUrl = `https://www.youtube.com/watch?v=${videoId}`;

Â  Â  Â  // Create fallback button
Â  Â  Â  const btn = document.createElement('a');
Â  Â  Â  btn.id = 'fallback-button';
Â  Â  Â  btn.href = ytUrl;
Â  Â  Â  btn.target = '_blank';
Â  Â  Â  btn.rel = 'noopener noreferrer';
Â  Â  Â  btn.textContent = 'â–¶ï¸ Watch on YouTube';
Â  Â  Â  container.appendChild(btn);

Â  Â  Â  // Hide other UI elements we won't use here
Â  Â  Â  document.getElementById('mute-toggle').style.display = 'none';
Â  Â  Â  document.getElementById('scrolling-banner').style.pointerEvents = 'auto'; // keep banner interactive
Â  Â  }

Â  Â  // Parse 'ch' param from URL query string, default to '1'
Â  Â  function getChannelFromUrl() {
Â  Â  Â  const params = new URLSearchParams(window.location.search);
Â  Â  Â  const ch = params.get('ch');
Â  Â  Â  return ch ? ch : '1';
Â  Â  }

Â  Â  const ch = getChannelFromUrl();
Â  Â  const playlistURL = `https://raw.githubusercontent.com/mstvnetwork/mstv1/main/sync-ch${ch}.json`;


Â  Â  let player;
Â  Â  let playlist = [];
Â  Â  let startTimeUTC = null;
Â  Â  let currentVideoIndex = 0;
Â  Â  let startSeconds = 0;
Â  Â  let isMuted = true;
Â  Â  let failSafeTimeout;

Â  Â  // Load YouTube Iframe API
Â  Â  function loadYouTubeAPI() {
Â  Â  Â  const tag = document.createElement('script');
Â  Â  Â  tag.src = "https://www.youtube.com/iframe_api";
Â  Â  Â  document.head.appendChild(tag);
Â  Â  }

Â  Â  // Update marquee text with current video title
Â  Â  function updateBanner() {
Â  Â  Â  const marquee = document.getElementById('marquee-text');
Â  Â  Â  if (playlist.length === 0) {
Â  Â  Â  Â  marquee.textContent = 'No videos in playlist';
Â  Â  Â  } else {
Â  Â  Â  Â  marquee.textContent = `Now Playing: ${playlist[currentVideoIndex].title}`;
Â  Â  Â  }
Â  Â  }

Â  Â  // Fail-safe timeout logic for skipping failed loads
Â  Â  function setFailSafe() {
Â  Â  Â  clearTimeout(failSafeTimeout);
Â  Â  Â  failSafeTimeout = setTimeout(() => {
Â  Â  Â  Â  console.warn("Video failed to load within 10 seconds. Skipping...");
Â  Â  Â  Â  currentVideoIndex = (currentVideoIndex + 1) % playlist.length;
Â  Â  Â  Â  startSeconds = 0;
Â  Â  Â  Â  player.loadVideoById({
Â  Â  Â  Â  Â  videoId: playlist[currentVideoIndex].id,
Â  Â  Â  Â  Â  startSeconds: startSeconds
Â  Â  Â  Â  });
Â  Â  Â  Â  updateBanner();
Â  Â  Â  Â  setFailSafe(); // restart timeout for new video
Â  Â  Â  }, 10000); // 10 seconds
Â  Â  }

Â  Â  // Sync player time to global start_time_utc and playlist durations
Â  Â  function syncAndPlay() {
Â  Â  Â  if (!startTimeUTC || playlist.length === 0) return;

Â  Â  Â  const now = Date.now();
Â  Â  Â  const elapsedSeconds = Math.floor((now - startTimeUTC) / 1000);
Â  Â  Â  const totalDuration = playlist.reduce((sum, video) => sum + video.duration_seconds, 0);
Â  Â  Â  const loopedElapsed = elapsedSeconds % totalDuration;

Â  Â  Â  let accumulated = 0;
Â  Â  Â  for (let i = 0; i < playlist.length; i++) {
Â  Â  Â  Â  if (loopedElapsed < accumulated + playlist[i].duration_seconds) {
Â  Â  Â  Â  Â  currentVideoIndex = i;
Â  Â  Â  Â  Â  startSeconds = loopedElapsed - accumulated;
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  }
Â  Â  Â  Â  accumulated += playlist[i].duration_seconds;
Â  Â  Â  }
Â  Â  Â  if (startSeconds < 0) startSeconds = 0;

Â  Â  Â  updateBanner();

Â  Â  Â  if (!player) {
Â  Â  Â  Â  player = new YT.Player('player', {
Â  Â  Â  Â  Â  height: '360',
Â  Â  Â  Â  Â  width: '640',
Â  Â  Â  Â  Â  videoId: playlist[currentVideoIndex].id,
Â  Â  Â  Â  Â  playerVars: {
Â  Â  Â  Â  Â  Â  autoplay: 1,
Â  Â  Â  Â  Â  Â  controls: 0,
Â  Â  Â  Â  Â  Â  modestbranding: 1,
Â  Â  Â  Â  Â  Â  rel: 0,
Â  Â  Â  Â  Â  Â  fs: 0,
Â  Â  Â  Â  Â  Â  start: startSeconds,
Â  Â  Â  Â  Â  Â  mute: 1
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  events: {
Â  Â  Â  Â  Â  Â  onReady: (event) => {
Â  Â  Â  Â  Â  Â  Â  if (isMuted) event.target.mute();
Â  Â  Â  Â  Â  Â  Â  else event.target.unMute();
Â  Â  Â  Â  Â  Â  Â  event.target.playVideo();
Â  Â  Â  Â  Â  Â  Â  setFailSafe();

Â  Â  Â  Â  Â  Â  Â  // âœ… Green screen fix (injected styling)
Â  Â  Â  Â  Â  Â  Â  const iframe = document.querySelector('#player iframe');
Â  Â  Â  Â  Â  Â  Â  if (iframe) {
Â  Â  Â  Â  Â  Â  Â  Â  iframe.style.transform = 'translateZ(0)';
Â  Â  Â  Â  Â  Â  Â  Â  iframe.style.backfaceVisibility = 'hidden';
Â  Â  Â  Â  Â  Â  Â  Â  iframe.style.willChange = 'transform';
Â  Â  Â  Â  Â  Â  Â  Â  iframe.style.backgroundColor = 'black';
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  onStateChange: (event) => {
Â  Â  Â  Â  Â  Â  Â  if (event.data === YT.PlayerState.PLAYING) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loading-overlay').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  clearTimeout(failSafeTimeout);
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  if (event.data === YT.PlayerState.ENDED) {
Â  Â  Â  Â  Â  Â  Â  Â  currentVideoIndex = (currentVideoIndex + 1) % playlist.length;
Â  Â  Â  Â  Â  Â  Â  Â  startSeconds = 0;
Â  Â  Â  Â  Â  Â  Â  Â  player.loadVideoById({
Â  Â  Â  Â  Â  Â  Â  Â  Â  videoId: playlist[currentVideoIndex].id,
Â  Â  Â  Â  Â  Â  Â  Â  Â  startSeconds: startSeconds
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  updateBanner();
Â  Â  Â  Â  Â  Â  Â  Â  setFailSafe();
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  } else {
Â  Â  Â  Â  player.loadVideoById({
Â  Â  Â  Â  Â  videoId: playlist[currentVideoIndex].id,
Â  Â  Â  Â  Â  startSeconds: startSeconds
Â  Â  Â  Â  });
Â  Â  Â  Â  setFailSafe();
Â  Â  Â  }
Â  Â  }

Â  Â  // Fetch JSON playlist and init player or fallback
Â  Â  async function fetchPlaylist() {
Â  Â  Â  try {
Â  Â  Â  Â  const res = await fetch(jsonUrl);
Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  playlist = data.video_list || [];
Â  Â  Â  Â  startTimeUTC = new Date(data.start_time_utc).getTime();

Â  Â  Â  Â  if (detectProblematicBrowser()) {
Â  Â  Â  Â  Â  showWarningAndFallback();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  loadYouTubeAPI();
Â  Â  Â  Â  }
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error('Error fetching JSON:', e);
Â  Â  Â  Â  // Optional: show error to user
Â  Â  Â  }
Â  Â  }

Â  Â  // Mute toggle logic
Â  Â  const muteToggle = document.getElementById('mute-toggle');
Â  Â  const muteKey = 'ytPlayerMuted';

Â  Â  if (sessionStorage.getItem(muteKey) === 'false') {
Â  Â  Â  isMuted = false;
Â  Â  Â  muteToggle.textContent = 'ğŸ”Š';
Â  Â  } else {
Â  Â  Â  isMuted = true;
Â  Â  Â  muteToggle.textContent = 'ğŸ”‡';
Â  Â  }

Â  Â  muteToggle.addEventListener('click', () => {
Â  Â  Â  if (!player) return;
Â  Â  Â  if (isMuted) {
Â  Â  Â  Â  player.unMute();
Â  Â  Â  Â  isMuted = false;
Â  Â  Â  Â  muteToggle.textContent = 'ğŸ”Š';
Â  Â  Â  Â  sessionStorage.setItem(muteKey, 'false');
Â  Â  Â  } else {
Â  Â  Â  Â  player.mute();
Â  Â  Â  Â  isMuted = true;
Â  Â  Â  Â  muteToggle.textContent = 'ğŸ”‡';
Â  Â  Â  Â  sessionStorage.setItem(muteKey, 'true');
Â  Â  Â  }
Â  Â  });

Â  Â  window.onYouTubeIframeAPIReady = () => {
Â  Â  Â  syncAndPlay();

Â  Â  Â  // Optional smarter resync every 30s ONLY if not currently playing
Â  Â  Â  setInterval(() => {
Â  Â  Â  Â  if (!player || player.getPlayerState() !== YT.PlayerState.PLAYING) {
Â  Â  Â  Â  Â  console.log("Re-syncing because player not playing...");
Â  Â  Â  Â  Â  syncAndPlay();
Â  Â  Â  Â  }
Â  Â  Â  }, 30000);
Â  Â  };

Â  Â  fetchPlaylist();
Â  </script>
</body>
</html>
