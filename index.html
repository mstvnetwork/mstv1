<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Global Sync MP4 Channel</title>
  <style>
    body { margin: 0; background: black; }
    #video { width: 100%; height: 100vh; background: black; object-fit: contain; }
    #banner {
      position: fixed; bottom: 0; width: 100%;
      background: blue; color: white; padding: 8px;
      white-space: nowrap; overflow: hidden;
    }
    #banner span {
      display: inline-block;
      animation: scroll 15s linear infinite;
    }
    @keyframes scroll {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }
    #mute-btn {
      position: fixed; top: 10px; right: 10px;
      background: rgba(0,0,0,0.6); color: white;
      font-size: 20px; padding: 6px 10px;
      border: none; border-radius: 5px;
    }
    #spinner {
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      border: 6px solid white;
      border-top: 6px solid gold;
      border-radius: 50%;
      width: 50px; height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

<video id="video" autoplay muted playsinline></video>
<div id="spinner"></div>
<button id="mute-btn">ðŸ”‡</button>
<div id="banner"><span>Loading...</span></div>
<script>
const video = document.getElementById('video');
const banner = document.querySelector('#banner span');
const muteBtn = document.getElementById('mute-btn');
const spinner = document.getElementById('spinner');

const params = new URLSearchParams(window.location.search);
const ch = params.get("ch") || "1";
const playlistURL = `sync-ch${ch}.json`;

let playlist = [];
let startTimeUTC = 0;

fetch(playlistURL)
  .then(res => res.json())
  .then(data => {
    playlist = data.video_list;
    startTimeUTC = new Date(data.start_time_utc).getTime() / 1000;
    syncAndPlay();
  });

function syncAndPlay() {
  const nowUTC = Date.now() / 1000;
  const elapsed = nowUTC - startTimeUTC;

  const totalDuration = playlist.reduce((sum, vid) => sum + vid.duration_seconds, 0);
  const relativeTime = elapsed % totalDuration;

  let currentIndex = 0, slotStart = 0;

  for (let i = 0; i < playlist.length; i++) {
    const vid = playlist[i];
    if (relativeTime < slotStart + vid.duration_seconds) {
      currentIndex = i;
      break;
    }
    slotStart += vid.duration_seconds;
  }

  const currentVideo = playlist[currentIndex];
  const seekTime = Math.floor(relativeTime - slotStart);
  playVideo(currentVideo, seekTime);
}

function playVideo(videoItem, seekTime) {
  banner.textContent = "Now Playing: " + videoItem.title;
  video.src = videoItem.url;

  video.onloadedmetadata = () => {
    spinner.style.display = 'none';
    const safeSeek = Math.min(videoItem.duration_seconds - 1, seekTime);
    video.currentTime = safeSeek;
    video.play().catch(err => console.warn("Autoplay failed:", err));
  };

  video.onerror = () => {
    spinner.style.display = 'none';
    banner.textContent = "âš ï¸ Failed to load video.";
  };
}

video.onended = () => {
  syncAndPlay(); // immediately play the next based on UTC
};

muteBtn.onclick = () => {
  video.muted = !video.muted;
  muteBtn.textContent = video.muted ? "ðŸ”‡" : "ðŸ”Š";
};

setInterval(syncAndPlay, 60000); // re-sync every 60s in case user stays long
</script>
</body>
</html>
