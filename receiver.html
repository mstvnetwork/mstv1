<!DOCTYPE html>
<html>
<head>
  <title>Screen Receiver - MSTV</title>
</head>
<body>
  <h2>Watching Cast</h2>
  <video id="video" autoplay playsinline controls style="width: 100%; max-width: 600px;"></video>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const castId = urlParams.get('castid') || 'mystream';

    const video = document.getElementById('video');
    const socket = new WebSocket('wss://mapping-moms-bi-guide.trycloudflare.com');

    let peer;

    socket.onopen = () => {
      console.log("Connected to signaling server");
      // Join signaling server with role 'receiver'
      socket.send(JSON.stringify({ type: "join", castId, payload: { role: "receiver" } }));
    };

    socket.onmessage = async ({ data }) => {
      let msg;
      try {
        msg = JSON.parse(data);
      } catch {
        console.warn("Non-JSON message:", data);
        return;
      }

      if (msg.type === "offer") {
        // Incoming offer from sender
        peer = new RTCPeerConnection();

        peer.ontrack = (event) => {
          if (video.srcObject !== event.streams[0]) {
            video.srcObject = event.streams[0];
            console.log('Received remote stream');
          }
        };

        peer.onicecandidate = (e) => {
          if (e.candidate) {
            socket.send(JSON.stringify({
              type: "ice-candidate",
              castId,
              payload: { candidate: e.candidate, to: "sender" }
            }));
          }
        };

        await peer.setRemoteDescription(new RTCSessionDescription(msg.payload.offer));

        const answer = await peer.createAnswer();
        await peer.setLocalDescription(answer);

        socket.send(JSON.stringify({ 
          type: "answer", 
          castId, 
          payload: { answer }
        }));

      } else if (msg.type === "ice-candidate") {
        await peer.addIceCandidate(new RTCIceCandidate(msg.payload.candidate));
      }
    };
  </script>
</body>
</html>
